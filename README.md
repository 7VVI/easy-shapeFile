ShapeFileåŸç†

### ğŸ“‚ Shapefile æ–‡ä»¶ç»“æ„

> ä¸€ä¸ªç®€å•çš„ShpeFileæ–‡ä»¶ç»“æ„

![image-20251202171835639](https://picgo-liziyuan.oss-cn-hangzhou.aliyuncs.com/zhd202512021718713.png)

Shapefile æ˜¯ä¸€ç§å¸¸è§çš„æ–‡ä»¶æ ¼å¼ï¼ŒåŒ…å«è®¸å¤šç›¸åŒç±»å‹çš„ç‰¹å¾ï¼ˆFeatureï¼‰ã€‚æ¯ä¸ª Shapefile åªæœ‰ä¸€ä¸ªç‰¹å¾ç±»å‹ (FeatureType)ã€‚

Shapefile çš„ .shp æ–‡ä»¶å­˜å‚¨çš„æ˜¯ åŒä¸€ç±»å‹çš„ Featureï¼Œä¾‹å¦‚ï¼š

- ç‚¹ (Point)
- çº¿ (LineString)
- é¢/å¤šè¾¹å½¢ (Polygon / MultiPolygon)

#### ç»å…¸çš„ä¸‰å¤§æ–‡ä»¶ï¼š

- filename.shp: å­˜å‚¨å‡ ä½•å½¢çŠ¶ (shapes),ä¾‹å¦‚å®ƒæ˜¯ç‚¹ã€çº¿è¿˜æ˜¯é¢ç‰¹å¾ã€‚ã€‚
- filename.shx: å½¢çŠ¶åˆ°å±æ€§çš„ç´¢å¼• (shapes to attributes index)ã€‚
- filename.dbf: å±æ€§æ•°æ® (attributes),æ˜¯æ•°æ®åº“æ–‡ä»¶ï¼Œå­˜å‚¨åœ¨å±æ€§è¡¨ä¸­æŸ¥çœ‹çš„æ•°æ®ã€‚

#### åŸºæœ¬å…ƒæ•°æ®ï¼š

- filename.prj: å­˜å‚¨æŠ•å½±ä¿¡æ¯ (projection),ç”¨äºæ­£ç¡®åœ°å°† Shapefile å®šä½åœ¨åœ°çƒè¡¨é¢ã€‚

#### å¼€æºæ‰©å±•ï¼ˆOpen source extensionsï¼‰ï¼š

- filename.qix: å››å‰æ ‘ç©ºé—´ç´¢å¼• (quadtree spatial index)ã€‚
- filename.fix: è¦ç´  ID ç´¢å¼• (feature id index)ã€‚
- filename.sld: æ ·å¼åŒ–å›¾å±‚æè¿°ç¬¦ (Styled Layer Descriptor) æ ·å¼ XML å¯¹è±¡ã€‚

#### ESRI ä¸“æœ‰æ‰©å±•ï¼ˆGeoTools å¿½ç•¥ï¼‰ï¼š

- filename.sbn: å±æ€§ç´¢å¼• (attribute index)ã€‚
- filename.sbx: ç©ºé—´ç´¢å¼• (spatial index)ã€‚
- filename.lyr: ä»… ArcMap å¯ç”¨çš„æ ·å¼å¯¹è±¡ã€‚
- filename.avl: ArcView æ ·å¼å¯¹è±¡ã€‚
- filename.shp.xml: FGDC å…ƒæ•°æ®ã€‚

è¿™ç§æ–‡ä»¶æ ¼å¼ï¼ˆè¯ç”Ÿäºå¾ˆä¹…ä»¥å‰ï¼‰è¢«ç§°ä¸º â€œè¾¹è½¦æ–‡ä»¶â€ (sidecar files) æ ¼å¼ã€‚æœ€å°‘éœ€è¦ filename.shp æ–‡ä»¶åŠå…¶è¾¹è½¦æ–‡ä»¶ filename.dbfã€‚

å¦‚æœ DataStore ä»…ç”¨äºè¯»å–ï¼Œæ–‡ä»¶å¯ä»¥è¢« gzip å‹ç¼©ï¼Œå¹¶é€šè¿‡é¢å¤–çš„æ–‡ä»¶åæ‰©å±•å .gz æ ‡è®°ã€‚

å¦‚æœ shp æˆ– shp.gz æ–‡ä»¶ç¼ºå¤±ï¼ŒGeoTools ä»ä¼šæä¾›ä¸å¸¦å‡ ä½•å½¢çŠ¶çš„è¦ç´ ã€‚å› æ­¤ï¼Œåªéœ€è¦ dbf æˆ– dbf.gz æ–‡ä»¶å­˜åœ¨å³å¯ã€‚æä¾›çš„ URL å¯ä»¥ä»¥ shpã€shp.gzã€dbf æˆ– dbf.gz ç»“å°¾ã€‚

**åªæœ‰  .shp  æ˜¯å…¥å£æ–‡ä»¶**

---

### ğŸ’¾ Shapefile å­˜å‚¨æ ¼å¼è¯¦è§£

Shapefile æ˜¯ä¸€ç§äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç›®æ ‡æ˜¯é«˜æ•ˆå­˜å‚¨å’Œè¯»å–ç©ºé—´å‡ ä½•æ•°æ®ã€‚äº†è§£å…¶å†…éƒ¨å­˜å‚¨ç»“æ„æœ‰åŠ©äºç†è§£ GIS è½¯ä»¶æ˜¯å¦‚ä½•è§£æè¿™äº›æ•°æ®çš„ã€‚

#### 1. ä¸»æ–‡ä»¶ (.shp) ç»“æ„
`.shp` æ–‡ä»¶ç”¨äºå­˜å‚¨å‡ ä½•æ•°æ®ï¼ˆåæ ‡ï¼‰ã€‚å®ƒç”± **æ–‡ä»¶å¤´ (Main File Header)** å’Œ **å˜é•¿è®°å½• (Variable Length Records)** ç»„æˆã€‚

**A. æ–‡ä»¶å¤´ (Main File Header)**
æ–‡ä»¶çš„å‰ 100 ä¸ªå­—èŠ‚æ˜¯å›ºå®šçš„æ–‡ä»¶å¤´ï¼ŒåŒ…å«å…³äºæ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ã€‚
*   **File Code (0-3å­—èŠ‚)**: æ•´æ•° `9994`ï¼Œç”¨äºæ ‡è¯†è¿™æ˜¯ä¸€ä¸ª Shapefileã€‚
*   **File Length (24-27å­—èŠ‚)**: æ–‡ä»¶æ€»é•¿åº¦ï¼ˆä»¥ 16 ä½å­—ä¸ºå•ä½ï¼‰ã€‚
*   **Version (28-31å­—èŠ‚)**: ç‰ˆæœ¬å·ï¼ˆé€šå¸¸ä¸º 1000ï¼‰ã€‚
*   **Shape Type (32-35å­—èŠ‚)**: å‡ ä½•ç±»å‹ä»£ç ï¼ˆä¾‹å¦‚ï¼š1=Point, 3=Polyline, 5=Polygonï¼‰ã€‚
*   **Bounding Box (36-99å­—èŠ‚)**: æ•´ä¸ªå›¾å±‚çš„ç©ºé—´èŒƒå›´ï¼ˆXmin, Ymin, Xmax, Ymax ç­‰ï¼‰ã€‚

**B. è®°å½• (Records)**
æ–‡ä»¶å¤´ä¹‹åæ˜¯è¿ç»­çš„è®°å½•ï¼Œæ¯ä¸ªè®°å½•ä»£è¡¨ä¸€ä¸ªå‡ ä½•è¦ç´ ã€‚æ¯ä¸ªè®°å½•åŒ…å«ä¸¤éƒ¨åˆ†ï¼š
*   **è®°å½•å¤´ (Record Header, 8å­—èŠ‚)**:
    *   è®°å½•å· (Record Number): ä» 1 å¼€å§‹çš„åºåˆ—å·ã€‚
    *   å†…å®¹é•¿åº¦ (Content Length): è¯¥è®°å½•å‡ ä½•æ•°æ®çš„é•¿åº¦ã€‚
*   **è®°å½•å†…å®¹ (Record Contents)**:
    *   å‡ ä½•ç±»å‹çš„å…·ä½“åæ ‡æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¯¹äºç‚¹ (Point)ï¼Œè¿™é‡Œå­˜å‚¨ X å’Œ Y åæ ‡ï¼›å¯¹äºé¢ (Polygon)ï¼Œè¿™é‡Œå­˜å‚¨å¤šä¸ªéƒ¨åˆ†çš„åæ ‡ç¯ (Rings)ã€‚

#### 2. ç´¢å¼•æ–‡ä»¶ (.shx) ç»“æ„
`.shx` æ–‡ä»¶æ˜¯ `.shp` æ–‡ä»¶çš„ç´¢å¼•ï¼Œç”¨äºå¿«é€Ÿè·³è½¬åˆ°ç‰¹å®šçš„å‡ ä½•è®°å½•ã€‚
*   å®ƒçš„æ–‡ä»¶å¤´ä¸ `.shp` ç›¸åŒï¼ˆ100 å­—èŠ‚ï¼‰ã€‚
*   ä¹‹åæ˜¯æ¯æ¡è®°å½•çš„ç´¢å¼•é¡¹ï¼Œæ¯é¡¹ 8 å­—èŠ‚ï¼š
    *   **åç§»é‡ (Offset)**: è¯¥è®°å½•åœ¨ `.shp` æ–‡ä»¶ä¸­çš„èµ·å§‹ä½ç½®ï¼ˆç›¸å¯¹äºæ–‡ä»¶å¤´çš„åç§»ï¼‰ã€‚
    *   **å†…å®¹é•¿åº¦ (Content Length)**: è¯¥è®°å½•çš„æ•°æ®é•¿åº¦ã€‚
*   **ä½œç”¨**: å½“éœ€è¦éšæœºè®¿é—®ç¬¬ N ä¸ªè¦ç´ æ—¶ï¼ŒGIS è½¯ä»¶ä¸éœ€è¦éå†æ•´ä¸ª `.shp` æ–‡ä»¶ï¼Œåªéœ€è¯»å– `.shx` ä¸­çš„ç¬¬ N ä¸ªç´¢å¼•é¡¹ï¼Œç„¶åç›´æ¥â€œè·³è½¬â€åˆ° `.shp` æ–‡ä»¶çš„å¯¹åº”ä½ç½®è¯»å–æ•°æ®ã€‚

#### 3. å±æ€§æ–‡ä»¶ (.dbf) ç»“æ„
`.dbf` æ–‡ä»¶å­˜å‚¨è¦ç´ çš„å±æ€§è¡¨æ•°æ®ï¼Œé‡‡ç”¨æ ‡å‡†çš„ dBase IV æ ¼å¼ã€‚
*   åŒ…å«è¡¨å¤´ï¼ˆå®šä¹‰å­—æ®µåã€ç±»å‹ã€é•¿åº¦ï¼‰å’Œè®°å½•æ•°æ®ã€‚
*   **.shp å’Œ .dbf çš„å¯¹åº”å…³ç³»**: å®ƒä»¬æ˜¯é€šè¿‡è®°å½•é¡ºåºä¸€ä¸€å¯¹åº”çš„ã€‚`.shp` ä¸­çš„ç¬¬ 1 ä¸ªå‡ ä½•ä½“å¯¹åº” `.dbf` ä¸­çš„ç¬¬ 1 è¡Œå±æ€§æ•°æ®ï¼Œä»¥æ­¤ç±»æ¨ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåˆ é™¤æˆ–æ–°å¢æ•°æ®æ—¶ï¼Œå¿…é¡»åŒæ—¶æ“ä½œè¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œå¦åˆ™ä¼šå¯¼è‡´å±æ€§é”™ä½ã€‚

---

### ğŸš€ GeoTools æ ¸å¿ƒæ¦‚å¿µä¸æ“ä½œæ•™å­¦

æœ¬é¡¹ç›®åŸºäº GeoTools åº“æ¼”ç¤ºäº†å¦‚ä½•é€šè¿‡ Java ä»£ç æ“ä½œ Shapefileã€‚ä»¥ä¸‹æ˜¯æ ¸å¿ƒæ¦‚å¿µçš„ç®€è¦è¯´æ˜ï¼š

#### 1. æ ¸å¿ƒæ¥å£
- **DataStore**: æ•°æ®å­˜å‚¨æ¥å£ï¼Œä»£è¡¨äº†ä¸€ä¸ªç‰©ç†æ•°æ®æºï¼ˆå¦‚ Shapefile æ–‡ä»¶ã€PostGIS æ•°æ®åº“ç­‰ï¼‰ã€‚
- **FeatureSource / FeatureStore**: ç”¨äºè¯»å–ï¼ˆSourceï¼‰å’Œå†™å…¥ï¼ˆStoreï¼‰è¦ç´ çš„æ¥å£ã€‚
- **SimpleFeature**: ç®€å•è¦ç´ ï¼Œä»£è¡¨åœ°å›¾ä¸Šçš„ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«å‡ ä½•ä¿¡æ¯ï¼ˆGeometryï¼‰å’Œå±æ€§ä¿¡æ¯ï¼ˆAttributesï¼‰ã€‚
- **SimpleFeatureType**: è¦ç´ ç±»å‹ï¼ˆSchemaï¼‰ï¼Œå®šä¹‰äº†è¦ç´ åŒ…å«å“ªäº›å­—æ®µä»¥åŠå­—æ®µçš„ç±»å‹ã€‚
- **Filter**: è¿‡æ»¤å™¨ï¼Œç”¨äºæŸ¥è¯¢ç¬¦åˆç‰¹å®šæ¡ä»¶çš„è¦ç´ ï¼ˆç±»ä¼¼ SQL çš„ WHERE å­å¥ï¼‰ã€‚

#### 2. ä»£ç ç¤ºä¾‹è¯´æ˜
æœ¬é¡¹ç›®æä¾›äº† `ShapeFileOperator.java` ç±»ï¼ŒåŒ…å«ä»¥ä¸‹æ•™å­¦ç¤ºä¾‹ï¼š

1.  **è¯»å– Shapefile (`readShapefileInfo`)**
    - å±•ç¤ºå¦‚ä½•è¿æ¥ Shapefileã€‚
    - æ‰“å° Schema ä¿¡æ¯ï¼ˆå­—æ®µåã€ç±»å‹ï¼‰ã€‚
    - éå†å¹¶æ‰“å°è¦ç´ æ•°æ®ã€‚

2.  **åˆ›å»º Shapefile (`createPointShapefile`)**
    - æ¼”ç¤ºå¦‚ä½•ä»é›¶å¼€å§‹åˆ›å»ºä¸€ä¸ªæ–°çš„ Shapefileã€‚
    - å®šä¹‰ Schemaï¼ˆä¾‹å¦‚ï¼šç‚¹åæ ‡ + åç§° + IDï¼‰ã€‚
    - ä½¿ç”¨ `SimpleFeatureBuilder` æ„å»ºè¦ç´ ã€‚
    - ä½¿ç”¨ `Transaction` äº‹åŠ¡æœºåˆ¶å®‰å…¨å†™å…¥æ•°æ®ã€‚

3.  **è¿‡æ»¤æŸ¥è¯¢ (`filterFeatures`)**
    - ä½¿ç”¨ CQL (Common Query Language) è¯­è¨€è¿›è¡ŒæŸ¥è¯¢ã€‚
    - ç¤ºä¾‹ï¼š`name = 'Beijing'` æˆ– `pop > 1000000`ã€‚
    - æ¼”ç¤ºå¦‚ä½•åªè·å–æ„Ÿå…´è¶£çš„æ•°æ®ã€‚

4.  **ç©ºé—´åˆ†æ - ç¼“å†²åŒº (`bufferFeatures`)**
    - æ¼”ç¤ºå‡ ä½•è¿ç®—ã€‚
    - å¯¹ç‚¹/çº¿/é¢è¦ç´ è¿›è¡Œ Bufferï¼ˆç¼“å†²ï¼‰æ“ä½œï¼Œç”Ÿæˆæ–°çš„é¢è¦ç´ ã€‚
    - å°†åˆ†æç»“æœä¿å­˜ä¸ºæ–°çš„ Shapefileã€‚

### ğŸ›  å¦‚ä½•è¿è¡Œ

1. ç¡®ä¿é¡¹ç›®ä¾èµ–å·²ä¸‹è½½ï¼ˆMavenï¼‰ã€‚
2. æ‰“å¼€ `src/main/java/com/zhangyh/shapefile/shapefile/ShapeFileOperator.java`ã€‚
3. è¿è¡Œ `main` æ–¹æ³•ã€‚
   - ç¨‹åºä¼šå°è¯•è¯»å–ç¤ºä¾‹æ–‡ä»¶ã€‚
   - åœ¨é¡¹ç›®æ ¹ç›®å½•ç”Ÿæˆ `new_points.shp`ï¼ˆåˆ›å»ºç¤ºä¾‹ï¼‰ã€‚
   - åœ¨é¡¹ç›®æ ¹ç›®å½•ç”Ÿæˆ `buffered_result.shp`ï¼ˆç¼“å†²åŒºåˆ†æç¤ºä¾‹ï¼‰ã€‚

### ğŸ“š æ‰©å±•é˜…è¯»
- [GeoTools å®˜æ–¹æ–‡æ¡£](https://docs.geotools.org/)
- [OGC ç®€å•è¦ç´ è§„èŒƒ](https://www.ogc.org/standards/sfa)
